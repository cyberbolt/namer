sudo: true
dist: xenial
language: python
python:
  - "3.6"

services:
- docker

branches:
  only:
    - master

env:
  - TF_INPUT=false

# Install terraform
before_install:
  - curl -sLo /tmp/terraform.zip https://releases.hashicorp.com/terraform/0.12.6/terraform_0.12.6_linux_amd64.zip
  - unzip /tmp/terraform.zip -d /tmp
  - mkdir -p ~/bin
  - mv /tmp/terraform ~/bin
  - export PATH="~/bin:$PATH"

jobs:
  include:
    - stage: build docker image
      script:
      - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
      - docker build -t namer-demo .
      - docker images
      - docker tag namer-demo $DOCKER_USERNAME/namer
      - docker push $DOCKER_USERNAME/namer
    - stage: integration testing
      script:
        - IP=$(hostname -I | awk '{ print $1 }')
        - URL=$IP:5000
        - M_HOST=$IP docker-compose up -d
        - M_HOST=$IP docker run namer-demo "integrationtests -u ${URL}"
        - docker-compose down
    - stage: finalize
      script: 
      - docker rmi -f namer-demo